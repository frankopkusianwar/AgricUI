<div>
  <app-navigation></app-navigation>
  <app-app-dashboard-navigation></app-app-dashboard-navigation>

  <div class="dash-section m-5 p-3 bg-white">
    <div class="m-4">
      <div class="col font-weight-bold text-black-50 ">
        Orders/{{ type }} Orders
      </div>
      <div class="col" (click)="showFilter = !showFilter">
        <button
          class="btn float-right btn-md text-white px-3 filter-orange-bg mt-n4"
          id="toggleMessage"
        >
          <span *ngIf="!showFilter"
            >Show filter<i class="fas fa-chevron-down"></i
          ></span>
          <span *ngIf="showFilter"
            >Hide filter<i class="fas fa-chevron-up"></i
          ></span>
        </button>
      </div>
    </div>
    <div *ngIf="showFilter">
        <div class="m-5">
          <div class="row pt-1 border-bottom filter-panel">
            <div class="col-10 w-100">
              <div class="row">
                <div class="col-sm-6">
                  <p class="font-weight-bold">Date Range</p>
                  <div class="row">
                    <div class="col-sm-6">
                      <input [owlDateTime]="dt1" [owlDateTimeTrigger]="dt1" placeholder="Start Date" class="form-control" [(ngModel)]="startDateVal"/>
                      <owl-date-time [pickerType]="'calendar'" #dt1></owl-date-time>
                    </div>
                    <div class="col-sm-6">
                      <input [owlDateTime]="dt2" [owlDateTimeTrigger]="dt2" placeholder="End Date" class="form-control" [(ngModel)]="endDateVal"/>
                      <owl-date-time [pickerType]="'calendar'" #dt2></owl-date-time>
                    </div>
                  </div>
                </div>
                <div class="col-sm-3">
                  <p class="font-weight-bold">Payment Method</p>
                  <select class="browser-default custom-select" [(ngModel)]="paymentMethod">
                    <option value="all">All</option>
                    <option value="cash">Cash</option>
                    <option value="mm">Mobile Money</option>
                  </select>
                </div>

                <div class="col-sm-3">
                  <p class="font-weight-bold">Amount Range</p>
                  <select class="w-100 custom-select" [(ngModel)]="amount">
                    <option value='all'>All</option>
                    <option value=250000>0 - 250,000</option>
                    <option value=500000>250,000 - 500,000</option>
                    <option value=750000>500,000 - 750,000</option>
                    <option value=1000000>750,000 - 1,000,000</option>
                    <option value=1000001>Above 1,000,000</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="col-2 buttons" align="right">
              <button
                (click)="filterQuery()"
                class="btn btn-md filter-teal-bg text-white apply"
              >
                Apply
              </button>
              <button
                (click)="Clear()"
                class="btn btn-md bg-dark disabled text-white clear"
              >
                Clear
              </button>
            </div>
            <div class="col-1">
            </div>
          </div>
        </div>
    </div>
  </div>

  <div class="dash-section m-5 bg-white">
    <div class="col  ">
      <div class="row dash-section px-5 ">
        <div class="col ">
          <h3 class="mt-3 py-2">List of {{ type }} Orders</h3>
        </div>
      </div>
      <div
        class="d-flex justify-content-center m-5 p-5 text-primary"
        *ngIf="!data"
      >
        <div class="spinner-border" role="status">
          <span class="sr-only">Loading...</span>
        </div>
      </div>
      <div class="row dash-section px-5" *ngIf="data && data.length === 0">
        <h4 class="d-flex justify-content-center p-5 text-primary">
          There are no orders at the moment
        </h4>
      </div>
      <div class="row dash-section px-5" *ngIf="data && data.length !== 0">
        <div class="col">
          <table class="table table-striped mt-2">
            <thead class="table_head text-white">
              <tr>
                <th scope="col">#</th>
                <th scope="col">Name</th>
                <th scope="col">Contact</th>
                <th scope="col">District</th>
                <th scope="col" *ngIf="type === 'Received'">Status</th>
                <th scope="col">Payment Method</th>
                <th scope="col">No. of Items</th>
                <th scope="col">Amount</th>
                <th scope="col">Date</th>

                <th scope="col">Action</th>
              </tr>
            </thead>
            <tbody>
              <tr
                *ngFor="
                  let list of dataToRender
                    | paginate: { itemsPerPage: count, currentPage: page } | orderBy:'status':true;
                  let i = index;
                "
                [ngClass]="{
                  'is-bold': list.status === 'New'
                }"
              >
                <th scope="row">{{ i + 1 }}</th>
                <td>{{ list.name | titlecase }}</td>
                <td>{{ list.phone }}</td>
                <td>{{ list.district | titlecase }}</td>
                <td *ngIf="type === 'Received'">{{ list.status }}</td>
                <td>{{ list.payment | paymentType | titlecase }}</td>
                <td class="pull-center">{{ list.total_items }}</td>
                <td>
                  {{ list.total_cost | currency: ' ':'symbol':'1.0' }}
                </td>
                <td class="col-date">{{ list.time | date }}</td>
                <td>
                  <div class="dropdown">
                    <button
                      class="btn btn-outline-info dropdown-toggle"
                      type="button"
                      id="dropdownMenuButton"
                      data-toggle="dropdown"
                      aria-haspopup="true"
                      aria-expanded="false"
                      (click)="clearMessage()"
                      >
                      ACTION
                    </button>
                    <div
                      class="dropdown-menu options"
                      aria-labelledby="dropdownMenuButton"
                    >
                      <a
                        class="dropdown-item"
                        data-toggle="modal"
                        data-target="#viewModal"
                        (click)="viewOrderDetails( list )">View</a>
                      
                      <a class="dropdown-item"
                        *ngIf="type === 'Received' && list.status === 'New'"
                        data-toggle="modal"
                        data-target="#clearOrderModal"
                        (click)="setSelectedOrder(list)">Mark as Cleared</a
                      >
                      <a 
                        class="dropdown-item"
                        data-toggle="modal"
                        data-target="#deleteModal"
                        (click)="viewOrderDetails( list )"
                        *ngIf="type === 'Received'"
                        >Delete</a>
                    </div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
          <nav aria-label="Page navigation">
            <pagination-controls
              (pageChange)="page = $event"
            ></pagination-controls>
          </nav>
        </div>


        <div class="modal fade" id="viewModal">
            <div class="modal-dialog modal-dialog-centered" role="document" style="max-width: 50%;">
              <div class="card modal-content">
                  <div class="modal-header">
                      <h4 class="modal-title text-info" id="modal-basic-title">Order Details</h4>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                  </div>
             
                  <div class="modal-body order-view-details">
                    <div class="container-fluid" *ngIf="orderData">
                        <div class="row my-2 py-2">
                            <div class="col text-secondary">Buyer</div><div class="col">{{ orderData.name }}</div>
                        </div>
                        <div class="row my-2 py-2">
                            <div class="col text-secondary">Payment</div><div class="col">{{ orderData.payment | paymentType | titlecase }}</div>
                        </div>
                        <div class="row my-2 py-2">
                            <div class="col text-secondary">Number Of Items</div><div class="col">{{ orderData.total_items }}</div>
                        </div>
                        <div class="row my-2 py-2">
                            <div class="col text-secondary">Date</div><div class="col">{{ orderData.time | date }}</div>
                        </div>
                        <h4 class="text-primary my-2 py-2 text-lg-left">Item Details</h4>
                        <table class="table">
                            <tbody>
                              <tr class="table-active">
                                <td scope="col" class="text-left">Product</td>
                                <td scope="col" class="text-left">Quantity</td>
                                <td scope="col" class="text-left">Unit Price(UGX)</td>
                                <td scope="col" class="text-left">Total Amount</td>
                              </tr>
                              <tr *ngFor="let order of orderData.orders" >
                                <td class="text-left">{{ order.product }}</td>
                                <td class="text-left">{{ order.qty }}</td>
                                <td class="text-left">{{ order.price }}</td>
                                <td class="text-left">{{ order.price * order.qty }}</td>
                              </tr>
                            </tbody>
                          </table>
                      </div>
                  </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-warning" data-dismiss="modal">
                    <span class="text-white">CLOSE</span>
                  </button>
                </div>
              </div>
            </div>
          </div>


          <div class="modal fade" id="deleteModal">
              <div class="modal-dialog modal-dialog-centered" role="document">
                  <div class="card modal-content" *ngIf="orderData">
                    <div class="modal-header">
                      <h4 class="modal-title text-info" id="modal-basic-title">Delete Order</h4>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
        
                    <div class="modal-body" *ngIf="!deleteOrderisloading && !deleteOrderisSuccess">
                        <span class="text-center" *ngIf="serverError">Some error occurred. Please try again</span>
                        Are you sure you want to delete this order
                    </div>

                    <div class="modal-body" *ngIf="deleteOrderisSuccess" style="text-align: center; padding: 3rem 0 3rem 0;">
                        <i class="far fa-check-circle fa-3x" style="color: teal; padding: 1rem 0 1rem 0"></i>
                        <h4>Success!</h4>
                        <p><span class="text-center">Order deleted successfully</span></p>
                        <button class="btn btn-md px-3 filter-teal-bg text-white" data-dismiss="modal">OK</button>
                    </div>

                    <div class="spinner d-flex" *ngIf="deleteOrderisloading">
                      <span
                        class="spinner-border spinner-border-md mx-auto"
                        role="status"
                      ></span>
                    </div>
                    <div class="modal-footer" *ngIf="!deleteOrderisloading && !deleteOrderisSuccess">
                      <button type="button" class="btn btn-danger"
                        (click)="deleteOrder(orderData._id)"
                        *ngIf="!serverError">
                        Delete Order
                      </button>
                      <button type="button" class="btn btn-secondary" 
                        data-dismiss="modal"
                        *ngIf="!serverError">
                        Close
                      </button>
                    </div>
                </div>
              </div>
            </div>
                  
          <div id="clearOrderModal" class="modal fade" data-backdrop="static" data-keyboard="false" tabindex="-1" *ngIf="showModal">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div *ngIf="!apiSuccess && !apiLoading" class="modal-header">
                    <h4 class="modal-title text-info">Clear Order</h4>
                    <button id="closeOrderModal" type="button" class="close" data-dismiss="modal">
                      <span>&times;</span>
                    </button>
                  </div>    
                  <div class="modal-body" *ngIf="!apiLoading && !apiSuccess" >
                    <div id="clear-order-wrapper">
                      <p>Are you sure you want to clear this order?</p>
                    </div>
                    <div class="clear-success" *ngIf=" apiError">
                      <i id="icon-times-error" class="far fa-times-circle fa-3x"></i>
                      <p> An error occured.</p>
                      <p> Unable to clear order.</p>
                    </div>
                </div>
                <div class="modal-body" *ngIf="apiLoading && !apiSuccess">
                    <div
                    class="d-flex justify-content-center m-5 p-5 text-primary"
                  >
                    <div class="spinner-border" role="status">
                      <span class="sr-only">Loading...</span>
                    </div>
                  </div>
                </div>
                <div class="modal-body" *ngIf="apiSuccess">
                  <div class="clear-success">
                      <i id="icon-check-success" class="far fa-check-circle fa-3x"></i>
                      <h4>Success!</h4>
                      <p>Order has been marked as cleared</p>
                      <button class="btn btn-md px-3 filter-teal-bg text-white" data-dismiss="modal" (click)="refreshTable()">OK</button>
                    </div>
                </div>
                <div *ngIf="!apiSuccess && !apiLoading" class="modal-footer">
                    <button
                      id="btnClearOrder"
                      type="button"
                      class="btn btn-md px-3 filter-teal-bg text-white"
                      (click)="clearOrder()"
                    >
                    Clear Order
                    </button>
                    <button
                      type="button"
                      class="btn btn-md px-3 btn-outline-dark"
                      data-dismiss="modal"
                      id="btnCloseClearOrder"
                    >
                      Close
                    </button>
                  </div>
              </div>
            </div>
          </div>
      </div>
    </div>
  <div class="m-4">&nbsp;</div>
</div>
